<div
	layout:decorate="~{layouts/main :: layout(sidebar='nutri', title='Healtry - Nutricionista: Dietas')}"
	layout:fragment="contenido">
	<script th:src="@{/js/nutri/dietas.js}"></script>

	<div class="container mt-4" x-data="dietaApp()" x-init="init()">
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h3 class="fw-semibold">Asignar Dietas a Clientes</h3>

			<input type="hidden" th:value="${session?.usuarioLogueado?.id}"
				name="idNutricionista" />
			<div class="d-flex flex-wrap gap-2">
				<button class="btn btn-success" @click="abrirModalCrear()">
					<i class="bi bi-plus-circle"></i> Crear dieta
				</button>

				<button class="btn btn-outline-secondary" @click="cargarPlanes()">
					<i class="bi bi-gear"></i> Recargar planes
				</button>

			</div>
		</div>

		<div class="card mb-3 shadow-sm">
			<div class="card-body">
				<div class="d-flex justify-content-between align-items-center">
					<h6 class="mb-0">Dietas del nutricionista</h6>
					<small class="text-muted" x-show="dietas.length === 0">No
						hay dietas creadas.</small>
				</div>

				<div class="table-responsive"
					style="max-height: 60vh; overflow-y: auto;">
					<table class="table table-hover align-middle">
						<thead class="main-color-light">
							<tr>
								<th>Plan</th>
								<th>Fechas</th>
								<th>Clientes</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							<template x-for="d in dietas" :key="d.id">
								<tr>
									<td>
										<div>
											<strong x-text="d.plan?.alias || ('Plan ' + d.idPlan)"></strong>
										</div>
										<div class="small text-muted" x-text="'id: ' + d.id"></div>
									</td>
									<td
										x-text="formatFecha(d.fechaInicio) + ' — ' + formatFecha(d.fechaFin)"></td>
									<td>
										<template x-for="c in d.clientesPreview || []" :key="c">
											<span class="badge bg-light text-dark me-1" x-text="c"></span>
										</template>
										<template
											x-if="!(d.clientesPreview && d.clientesPreview.length)">
											<span class="small text-muted">Sin clientes</span>
										</template>
									</td>
									<td class="text-end">
										<button class="btn btn-sm btn-primary me-1"
											@click="abrirEditarDieta(d)">
											<i class="bi bi-pencil"></i>
										</button>
										<button class="btn btn-sm btn-danger"
											@click="confirmarEliminarDieta(d)">
											<i class="bi bi-trash"></i>
										</button>
									</td>
								</tr>
							</template>

							<tr x-show="dietas.length === 0">
								<td colspan="4" class="text-center text-muted">No hay
									dietas.</td>
							</tr>
						</tbody>
					</table>
				</div>

			</div>
		</div>

		<!-- (Opcional) Información / ayuda -->
		<template x-if="showInfo()">
		<div class="alert alert-info small">Crea una dieta eligiendo un
			plan semanal, fechas de inicio/fin y asigna uno o más clientes. Las
			dietas existentes aparecen arriba).</div>
		</template>

		<!-- Modales -->
		<div th:replace="~{nutri/modales/modales-dietas}"></div>
	</div>
</div>
